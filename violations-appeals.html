<script>
document.addEventListener("DOMContentLoaded", () => {
  const mainContainer = document.querySelector(".main-container");

  // Load violations from localStorage
  const formData = JSON.parse(localStorage.getItem("violations") || "{}");
  const modernViolations = formData?.modernViolations || [];

  // Always render default card
  const defaultCard = document.createElement("div");
  defaultCard.className = "card";
  defaultCard.innerHTML = `
    <h3>Appeal a decision that is not shown</h3>
    <p>You may request an appeal for something that is not shown here.</p>
  `;
  defaultCard.onclick = () => (window.location.href = "/report-mistake");
  mainContainer.appendChild(defaultCard);

  // If no modern violations, stop here
  if (!modernViolations.length) return;

  // Create a section for rendered violation details
  const violationDetails = document.createElement("div");
  violationDetails.id = "violationDetails";
  violationDetails.style.marginTop = "20px";
  mainContainer.appendChild(violationDetails);

  // Render a card for each modern violation
  modernViolations.forEach((violation, idx) => {
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <h3>Your ${violation.violationType} broke the rules</h3>
      <p>${violation.reason}</p>
    `;

    card.onclick = () => {
      renderViolationBox(violation);
    };

    mainContainer.insertBefore(card, violationDetails);
  });

  // Function to render violation details box
  function renderViolationBox(violation) {
    violationDetails.innerHTML = ""; // clear previous

    const box = document.createElement("div");
    box.className = "evidence-box";
    box.style.cssText = `
      background: #fff;
      padding: 16px;
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
    `;

    const reason = document.createElement("p");
    reason.innerHTML = `Violation<br><b>${violation.reason}</b>`;
    box.appendChild(reason);

    const id = document.createElement("p");
    id.innerHTML = `Asset ID<br><b>${violation.assetId || "N/A"}</b>`;
    box.appendChild(id);

    // Name / type-specific labels
    if (violation.violationType === "Model") {
      const modelName = document.createElement("p");
      modelName.innerHTML = `Model Name<br><b>${violation.evidence || "N/A"}</b>`;
      box.appendChild(modelName);
      const label = document.createElement("p");
      label.textContent = "Model";
      box.appendChild(label);
    }
    if (violation.violationType === "UGC Bundle") {
      const bundleName = document.createElement("p");
      bundleName.innerHTML = `Bundle Name<br><b>${violation.evidence || "N/A"}</b>`;
      box.appendChild(bundleName);
      const label = document.createElement("p");
      label.textContent = "Bundle";
      box.appendChild(label);
    }
    if (violation.violationType === "Image" || violation.violationType === "Profile Picture") {
      const label = document.createElement("p");
      label.textContent = violation.violationType;
      box.appendChild(label);

      const img = document.createElement("img");
      img.className = "evidence-image";
      img.src = violation.evidence;
      img.style.maxWidth = "360px";
      img.style.marginTop = "8px";
      box.appendChild(img);
    }

    // Appeal button
    const appealBtn = document.createElement("button");
    appealBtn.textContent = "Request Appeal";
    appealBtn.style.cssText = `
      margin-top: 20px;
      padding: 10px 16px;
      background: #4a90e2;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    `;
    appealBtn.onclick = () => openAppealModal(appealBtn);
    box.appendChild(appealBtn);

    violationDetails.appendChild(box);
  }

  // Modal logic
  const modalOverlay = document.createElement("div");
  modalOverlay.className = "modal-overlay";
  modalOverlay.style.display = "none";
  modalOverlay.innerHTML = `
    <div class="modal">
      <h2>Submit Appeal</h2>
      <textarea id="appealDescription" placeholder="Enter your appeal description" style="width:100%;min-height:100px;margin-bottom:12px;"></textarea>
      <button id="submitAppeal" class="modal-btn">Submit</button>
    </div>
  `;
  document.body.appendChild(modalOverlay);

  function openAppealModal(btn) {
    modalOverlay.style.display = "flex";
    modalOverlay.querySelector("#submitAppeal").onclick = () => {
      modalOverlay.querySelector(".modal").innerHTML = `
        <h2>We received your appeal</h2>
        <p>Responses may take up to 5 business days.</p>
        <button class="modal-btn" id="closeModal">Okay</button>
      `;
      modalOverlay.querySelector("#closeModal").onclick = () => {
        modalOverlay.style.display = "none";
        btn.textContent = "Appeal received";
        btn.disabled = true;
        btn.style.background = "#aaa";
      };
    };
  }
});
</script>
