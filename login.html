<script>
document.addEventListener('DOMContentLoaded', function() {
    const loginForm = document.getElementById('loginForm');
    const errorMessage = document.getElementById('errorMessage');
    const loading = document.getElementById('loading');

    async function sha256(message) {
        const msgBuffer = new TextEncoder().encode(message);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const username = document.getElementById('usernameInput').value.trim();
        const password = document.getElementById('password').value;

        loading.style.display = 'block';
        errorMessage.style.display = 'none';

        try {
            const response = await fetch('/users.json');
            if (!response.ok) throw new Error('Failed to fetch user data');
            const users = await response.json();

            const hashedPassword = await sha256(password);

            let userFound = null;
            for (const id in users) {
                if (users[id].username === username) {
                    userFound = users[id];
                    break;
                }
            }

            if (!userFound || userFound.key !== hashedPassword) {
                errorMessage.style.display = 'block';
                return;
            }

            localStorage.setItem('username', userFound.username);
            localStorage.setItem('ModPanelUsername', userFound.username);
            localStorage.removeItem('banFormData');

            // Redirect to /home; userHandling will do deleted/banned checks
            window.location.href = '/home';

        } catch (err) {
            console.error('Login error:', err);
            errorMessage.textContent = 'Login service unavailable. Please try again later.';
            errorMessage.style.display = 'block';
        } finally {
            loading.style.display = 'none';
        }
    });
});
</script>
