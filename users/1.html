<script>
(function(){
  const redirect500 = () => { window.location.href = '/500.html'; };
  const redirect404 = () => { window.location.href = '/404.html'; };
  const redirectDeleted = () => { window.location.href = '/userDeleted.html'; };

  // Helper to resolve image paths so "boiby.png" becomes "/boiby.png"
  function resolveImgPath(p) {
    if(!p) return '/placeholder.png';
    if(p.startsWith('http://') || p.startsWith('https://') || p.startsWith('/')) return p;
    // ensure no duplicate leading slashes
    return '/' + p.replace(/^\/+/, '');
  }

  // Get user id from path: supports:
  //  /users/1/
  //  /users/1/index.html
  //  /users/1.html
  function getUserIdFromPath(){
    const path = window.location.pathname || '/';
    // first try /users/<id> pattern
    let m = path.match(/\/users\/(\d+)(?:\/|$|\.html)/);
    if(m && m[1]) return m[1];
    // fallback: try last numeric segment
    const parts = path.split('/').filter(Boolean);
    for(let i = parts.length - 1; i >= 0; i--){
      if(/^\d+$/.test(parts[i])) return parts[i];
      // handle filename like "1.html"
      const fn = parts[i].split('?')[0].split('#')[0];
      const fnm = fn.split('.').slice(0, -1).join('.');
      if(/^\d+$/.test(fnm)) return fnm;
    }
    return null;
  }

  const userId = getUserIdFromPath();
  if(!userId) return redirect404();

  // fetch user data from root /users.json
  fetch('/users.json', { cache: 'no-store' })
    .then(resp => {
      if(!resp.ok) throw new Error('fetch-failed');
      return resp.json();
    })
    .then(data => {
      if(!data || typeof data !== 'object') throw new Error('invalid-json');

      const user = data[userId];
      if(!user) return redirect404();
      if(user.isDeleted) return redirectDeleted();

      // DOM targets (adjust if your markup differs)
      const profilePic = document.getElementById('profile-pic');
      const usernameEl = document.getElementById('username');
      const tagEl = document.getElementById('user-tag');
      const statsEl = document.getElementById('user-stats');
      const aboutAlias = document.getElementById('about-alias');
      const joinDateEl = document.getElementById('join-date');
      const friendsListEl = document.getElementById('friends-list');
      const friendsTitle = document.getElementById('friends-title');
      const friendsCard = document.getElementById('friends-card');

      // populate safe values
      profilePic.src = resolveImgPath(user.profilePicture || 'placeholder.png');
      profilePic.alt = (user.username || 'User') + ' avatar';
      usernameEl.textContent = user.username || 'Unknown';
      tagEl.textContent = '@' + (user.username || 'unknown');

      const friendsCount = Array.isArray(user.friends) ? user.friends.length : 0;
      const followers = Number(user.followers || 0);
      const following = Number(user.following || 0);
      statsEl.textContent = `${friendsCount} Friends · ${followers} Followers · ${following} Following`;

      aboutAlias.textContent = 'Alias: ' + (user.alias || '✶');
      // unify joinDate display (if JSON uses YYYY-MM-DD or similar)
      joinDateEl.textContent = user.joinDate || '—';

      // build friends list
      friendsListEl.innerHTML = '';
      if(!Array.isArray(user.friends) || user.friends.length === 0){
        friendsTitle.textContent = 'Friends (0)';
        // If you want to hide the whole card when empty:
        // friendsCard.style.display = 'none';
      } else {
        friendsTitle.textContent = `Friends (${friendsCount})`;
        user.friends.forEach(fid => {
          const friendData = data[String(fid)];
          // skip if no friend data or deleted
          if(!friendData || friendData.isDeleted) return;

          const a = document.createElement('a');
          // link to friend page in /users/<id>/
          a.href = `/users/${fid}/`;
          a.className = 'friend';
          a.title = friendData.username || `User ${fid}`;

          const img = document.createElement('img');
          img.src = resolveImgPath(friendData.profilePicture || 'placeholder.png');
          img.alt = friendData.username || `User ${fid}`;
          img.onerror = function(){ this.onerror = null; this.src = '/placeholder.png'; };

          const p = document.createElement('p');
          p.textContent = friendData.username || `User ${fid}`;

          a.appendChild(img);
          a.appendChild(p);
          friendsListEl.appendChild(a);
        });
      }
    })
    .catch(err => {
      console.error('User fetch/build error:', err);
      redirect500();
    });
})();
</script>
